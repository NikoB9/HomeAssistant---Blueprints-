blueprint:
  name: Synchronize multiple Switches/Lights
  description: >
    ## Bind multiple switches or lights together to act in unison
    ğŸ”¥ **Version**: v5.1 (optimized ZHA / Tuya)
    - Parallel service calls
    - Double-press protection
    - Prevents desynchronization
    - Designed for Zigbee (ZHA)
  domain: automation

  input:
    entities:
      name: Entities to synchronize
      description: Select two or more switches or lights to act together.
      selector:
        entity:
          multiple: true

    debounce:
      name: Debounce time (ms)
      description: Minimum time the state must remain stable before synchronization.
      default: 200
      selector:
        number:
          min: 0
          max: 1000
          unit_of_measurement: ms
          mode: slider

mode: restart
max_exceeded: silent

trigger:
  - platform: state
    entity_id: !input entities
    for:
      milliseconds: !input debounce

condition:
  - condition: template
    value_template: >
      {{ trigger.to_state.state in ['on', 'off']
         and trigger.to_state.state != trigger.from_state.state }}

action:
  - variables:
      new_state: "{{ trigger.to_state.state }}"
      source: "{{ trigger.entity_id }}"
      all_entities: !input entities
      targets: >
        {{ expand(all_entities)
           | rejectattr('entity_id', 'eq', source)
           | rejectattr('state', 'eq', new_state)
           | map(attribute='entity_id')
           | list }}

  - choose:
      - conditions:
          - condition: template
            value_template: "{{ targets | length > 0 }}"
        sequence:
          - service: >
              {{ 'homeassistant.turn_on'
                 if new_state == 'on'
                 else 'homeassistant.turn_off' }}
            target:
              entity_id: "{{ targets }}"
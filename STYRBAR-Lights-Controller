blueprint:
  name: ZHA â€“ IKEA STYRBAR â€“ ContrÃ´le lumiÃ¨re gÃ©nÃ©rique
  description: >
    Blueprint ZHA gÃ©nÃ©rique pour tÃ©lÃ©commande IKEA STYRBAR / TRÃ…DFRI.
    IncrÃ©ment/dÃ©crÃ©ment luminositÃ© et tempÃ©rature couleur.
    Supporte une entitÃ© dâ€™alimentation optionnelle (light ou switch).
  domain: automation

  input:
    remote_device:
      name: TÃ©lÃ©commande IKEA (ZHA)
      selector:
        device:
          integration: zha

    light_target:
      name: LumiÃ¨re ou groupe
      selector:
        entity:
          domain: light

    power_entity:
      name: EntitÃ© dâ€™alimentation (optionnelle)
      default: ""
      selector:
        entity:
          domain:
            - light
            - switch

    brightness_step:
      name: Pas luminositÃ© (%)
      default: 10
      selector:
        number:
          min: 1
          max: 50
          unit_of_measurement: "%"

    brightness_long_step:
      name: Pas luminositÃ© appui long (%)
      default: 5
      selector:
        number:
          min: 1
          max: 20

    color_temp_step:
      name: Pas tempÃ©rature couleur (mireds)
      default: 40
      selector:
        number:
          min: 10
          max: 200

    long_press_interval:
      name: Intervalle appui long (s)
      default: 0.3
      selector:
        number:
          min: 0.1
          max: 1
          step: 0.1

mode: restart

variables:
  light: !input light_target
  power: !input power_entity
  bri_step: !input brightness_step
  bri_long: !input brightness_long_step
  ct_step: !input color_temp_step
  interval: !input long_press_interval
  remote_device_id: "{{ device_id(remote_device) }}"

trigger:
  - platform: event
    event_type: zha_event

condition:
  - condition: template
    value_template: >
      {{ trigger.event.data.device_id == remote_device_id }}

action:
  - variables:
      command: "{{ trigger.event.data.command }}"

  # ğŸ”Œ Alimentation si dÃ©finie
  - if:
      - condition: template
        value_template: >
          {{ power != '' and states(power) == 'off' }}
    then:
      - service: >
          {{ power.split('.')[0] }}.turn_on
        target:
          entity_id: "{{ power }}"

  - choose:

      # ğŸ’¡ LuminositÃ© +
      - conditions: "{{ command == 'brightness_up' }}"
        sequence:
          - service: light.turn_on
            target: { entity_id: "{{ light }}" }
            data:
              brightness_step_pct: "{{ bri_step }}"

      # ğŸ’¡ LuminositÃ© â€“
      - conditions: "{{ command == 'brightness_down' }}"
        sequence:
          - service: light.turn_on
            target: { entity_id: "{{ light }}" }
            data:
              brightness_step_pct: "{{ -bri_step }}"

      # ğŸ¨ TempÃ©rature couleur â€“
      - conditions: "{{ command == 'arrow_left' }}"
        sequence:
          - service: light.turn_on
            target: { entity_id: "{{ light }}" }
            data:
              color_temp: >
                {{ state_attr(light, 'color_temp') | int
                   + ct_step
                   | min(state_attr(light, 'max_mireds') | default(500)) }}

      # ğŸ¨ TempÃ©rature couleur +
      - conditions: "{{ command == 'arrow_right' }}"
        sequence:
          - service: light.turn_on
            target: { entity_id: "{{ light }}" }
            data:
              color_temp: >
                {{ state_attr(light, 'color_temp') | int
                   - ct_step
                   | max(state_attr(light, 'min_mireds') | default(153)) }}

blueprint:
  name: ZHA â€“ IKEA STYRBAR â€“ ContrÃ´le lumiÃ¨re gÃ©nÃ©rique (sans helpers)
  description: >
    Blueprint ZHA gÃ©nÃ©rique pour tÃ©lÃ©commande IKEA STYRBAR / TRÃ…DFRI.
    Appui court et long gÃ©rÃ©s sans helpers externes.
  domain: automation

  input:
    remote_device:
      name: TÃ©lÃ©commande IKEA (ZHA)
      selector:
        device:
          integration: zha

    light_target:
      name: LumiÃ¨re ou groupe
      selector:
        entity:
          domain: light

    power_entity:
      name: EntitÃ© dâ€™alimentation (optionnelle)
      default: ""
      selector:
        entity:
          domain:
            - light
            - switch

    brightness_step:
      name: Pas luminositÃ© (%)
      default: 10
      selector:
        number:
          min: 1
          max: 50
          unit_of_measurement: "%"

    brightness_long_step:
      name: Pas luminositÃ© appui long (%)
      default: 5
      selector:
        number:
          min: 1
          max: 20

    color_temp_step:
      name: Pas tempÃ©rature couleur (mireds)
      default: 40
      selector:
        number:
          min: 10
          max: 200

    long_press_max_repeats:
      name: Max rÃ©pÃ©titions appui long
      default: 50
      selector:
        number:
          min: 1
          max: 500

    long_press_interval:
      name: Intervalle appui long (s)
      default: 0.3
      selector:
        number:
          min: 0.05
          max: 1
          step: 0.05

trigger:
  - platform: event
    event_type: zha_event

action:
  # 1ï¸âƒ£ On prÃ©pare TOUTES les variables
  - variables:
      event_device_id: "{{ trigger.event.data.device_id }}"
      remote_device_id: "{{ device_id(remote_device) }}"
      cmd: "{{ trigger.event.data.command }}"
      cid: "{{ trigger.event.data.cluster_id }}"
      args: "{{ trigger.event.data.args | default([]) }}"
      repeats: !input long_press_max_repeats
      interval: !input long_press_interval
      bri_step: !input brightness_step
      bri_long: !input brightness_long_step
      ct_step: !input color_temp_step
      light: !input light_target
      power: !input power_entity

  # 2ï¸âƒ£ VÃ‰RIFICATION DU DEVICE ðŸ”’
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ event_device_id == remote_device_id }}"
        sequence:

          # ðŸ” LOG DE DEBUG (tu peux lâ€™enlever plus tard)
          - service: system_log.write
            data:
              message: >
                ZHA OK device={{ event_device_id }} cmd={{ cmd }} cluster={{ cid }}
              level: info

          # Allume l'entitÃ© power si nÃ©cessaire
          - if:
              - condition: template
                value_template: "{{ power != '' and is_state(power, 'off') }}"
            then:
              - service: "{{ power.split('.')[0] }}.turn_on"
                target:
                  entity_id: "{{ power }}"

          # --- ACTIONS ---
          - choose:

              # Appui court luminositÃ© +
              - conditions: "{{ cid == 6 and cmd == 'on' }}"
                sequence:
                  - service: light.turn_on
                    target: { entity_id: "{{ light }}" }
                    data:
                      brightness_step_pct: "{{ bri_step }}"

              # Appui court luminositÃ© -
              - conditions: "{{ cid == 6 and cmd == 'off' }}"
                sequence:
                  - service: light.turn_on
                    target: { entity_id: "{{ light }}" }
                    data:
                      brightness_step_pct: "{{ -bri_step }}"

              # Appui long luminositÃ© +
              - conditions: >
                  {{ cid == 8 and cmd in ['move', 'move_with_on_off'] and args[0] == 0 }}
                sequence:
                  - repeat:
                      while: "{{ repeat.index <= repeats }}"
                      sequence:
                        - service: light.turn_on
                          target: { entity_id: "{{ light }}" }
                          data:
                            brightness_step_pct: "{{ bri_long }}"
                        - delay: "{{ interval }}"

              # Appui long luminositÃ© -
              - conditions: >
                  {{ cid == 8 and cmd in ['move', 'move_with_on_off'] and args[0] == 1 }}
                sequence:
                  - repeat:
                      while: "{{ repeat.index <= repeats }}"
                      sequence:
                        - service: light.turn_on
                          target: { entity_id: "{{ light }}" }
                          data:
                            brightness_step_pct: "{{ -bri_long }}"
                        - delay: "{{ interval }}"

              # TempÃ©rature couleur gauche
              - conditions: >
                  {{ cid == 5 and cmd == 'press' and args|first == 257 }}
                sequence:
                  - service: light.turn_on
                    target: { entity_id: "{{ light }}" }
                    data:
                      color_temp: >
                        {{ (state_attr(light, 'color_temp')|int + ct_step)
                           | min(state_attr(light,'max_mireds')|default(500)) }}

              # TempÃ©rature couleur droite
              - conditions: >
                  {{ cid == 5 and cmd == 'press' and args|first == 256 }}
                sequence:
                  - service: light.turn_on
                    target: { entity_id: "{{ light }}" }
                    data:
                      color_temp: >
                        {{ (state_attr(light, 'color_temp')|int - ct_step)
                           | max(state_attr(light,'min_mireds')|default(153)) }}

mode: restart

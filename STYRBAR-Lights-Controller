blueprint:
  name: ZHA – IKEA STYRBAR – Contrôle lumière générique (appui court & long robustes)
  description: >
    Blueprint ZHA pour télécommande IKEA STYRBAR / TRÅDFRI.
    Gère appui court, appui long, arrêt appui long et variation température couleur.
  domain: automation

  input:
    remote_device:
      name: Télécommande IKEA (ZHA)
      selector:
        device:
          integration: zha

    light_target:
      name: Lumière ou groupe
      selector:
        entity:
          domain: light

    power_entity:
      name: Entité d’alimentation (optionnelle)
      default: ""
      selector:
        entity:
          domain:
            - light
            - switch

    brightness_step:
      name: Pas luminosité (%)
      default: 10
      selector:
        number:
          min: 1
          max: 50
          unit_of_measurement: "%"

    brightness_long_step:
      name: Pas luminosité appui long (%)
      default: 5
      selector:
        number:
          min: 1
          max: 20

    color_temp_step:
      name: Pas température couleur (mireds)
      default: 40
      selector:
        number:
          min: 10
          max: 200

    long_press_max_repeats:
      name: Max répétitions appui long
      default: 50
      selector:
        number:
          min: 1
          max: 500

    long_press_interval:
      name: Intervalle appui long (s)
      default: 0.3
      selector:
        number:
          min: 0.05
          max: 1
          step: 0.05

mode: restart

trigger:
  - platform: event
    event_type: zha_event

action:
  - variables:
      device_id_remote: !input remote_device
      device_id_event: "{{ trigger.event.data.device_id }}"
      cmd: "{{ trigger.event.data.command }}"
      cid: "{{ trigger.event.data.cluster_id }}"
      args: "{{ trigger.event.data.args | default([]) }}"
      bri_step: !input brightness_step
      bri_long: !input brightness_long_step
      repeats: !input long_press_max_repeats
      interval: !input long_press_interval
      ct_step: !input color_temp_step
      light: !input light_target
      power: !input power_entity

  # Filtrer uniquement la télécommande attendue
  - condition: template
    value_template: "{{ device_id_event == device_id_remote }}"

  # Log debug pour voir la commande reçue
  - service: system_log.write
    data:
      level: info
      message: >
        Trigger device_id={{ device_id_event }} cmd={{ cmd }} cluster_id={{ cid }} args={{ args }}

  # Allumer l'entité d'alimentation si spécifiée et éteinte
  - if:
      - condition: template
        value_template: "{{ power != '' and is_state(power, 'off') }}"
    then:
      - service: "{{ power.split('.')[0] }}.turn_on"
        target:
          entity_id: "{{ power }}"

  # Gestion des appuis courts pour luminosité
  - choose:
      - conditions: "{{ cid == 6 and cmd == 'on' }}"
        sequence:
          - service: light.turn_on
            target:
              entity_id: "{{ light }}"
            data:
              brightness_step_pct: "{{ bri_step }}"

      - conditions: "{{ cid == 6 and cmd == 'off' }}"
        sequence:
          - service: light.turn_on
            target:
              entity_id: "{{ light }}"
            data:
              brightness_step_pct: "{{ -bri_step }}"

  # Gestion des appuis longs pour variation de luminosité
  - choose:
      # Appui long luminosité +
      - conditions: >
          {{ 
            cid == 8 and 
            cmd in ['move_with_on_off', 'move'] and 
            args is iterable and args|length > 0 and args[0] == 0
          }}
        sequence:
          - repeat:
              while: >
                {{
                  (
                    trigger.event.data.command in ['move_with_on_off', 'move']
                    and trigger.event.data.args is iterable
                    and trigger.event.data.args|length > 0
                    and trigger.event.data.args[0] == 0
                  )
                }}
              sequence:
                - service: light.turn_on
                  target:
                    entity_id: "{{ light }}"
                  data:
                    brightness_step_pct: "{{ bri_long }}"
                - delay: "{{ interval }}"

      # Appui long luminosité -
      - conditions: >
          {{ 
            cid == 8 and 
            cmd in ['move_with_on_off', 'move'] and 
            args is iterable and args|length > 0 and args[0] == 1
          }}
        sequence:
          - repeat:
              while: >
                {{
                  (
                    trigger.event.data.command in ['move_with_on_off', 'move']
                    and trigger.event.data.args is iterable
                    and trigger.event.data.args|length > 0
                    and trigger.event.data.args[0] == 1
                  )
                }}
              sequence:
                - service: light.turn_on
                  target:
                    entity_id: "{{ light }}"
                  data:
                    brightness_step_pct: "{{ -bri_long }}"
                - delay: "{{ interval }}"

      # Arrêt appui long (fin de variation)
      - conditions: "{{ cid == 8 and cmd in ['stop', 'stop_with_on_off'] }}"
        sequence:
          - service: system_log.write
            data:
              level: info
              message: "Appui long relâché - stop reçu"

  # Gestion de la variation de température couleur (seulement si la lumière supporte le color_temp)
  - choose:
      # Vérifier que la lumière a un attribut color_temp avant de gérer la variation
      - conditions: >
          {{
            state_attr(light, 'color_temp') is not none
          }}
        sequence:
          # Température couleur augmentation (bouton gauche)
          - choose:
              - conditions: >
                  {{ 
                    cid == 5 and 
                    cmd == 'press' and 
                    args is iterable and args|length > 0 and args[0] == 257 
                  }}
                sequence:
                  - service: light.turn_on
                    target:
                      entity_id: "{{ light }}"
                    data:
                      color_temp: >
                        {%- set ct = state_attr(light, 'color_temp') -%}
                        {%- set max_ct = state_attr(light, 'max_mireds') | default(500, true) -%}
                        {%- set current_ct = ct if ct is not none else max_ct -%}
                        {{ (current_ct | int + ct_step) | min(max_ct | int) }}

          # Température couleur diminution (bouton droit)
          - choose:
              - conditions: >
                  {{ 
                    cid == 5 and 
                    cmd == 'press' and 
                    args is iterable and args|length > 0 and args[0] == 256 
                  }}
                sequence:
                  - service: light.turn_on
                    target:
                      entity_id: "{{ light }}"
                    data:
                      color_temp: >
                        {%- set ct = state_attr(light, 'color_temp') -%}
                        {%- set min_ct = state_attr(light, 'min_mireds') | default(153, true) -%}
                        {%- set current_ct = ct if ct is not none else min_ct -%}
                        {{ (current_ct | int - ct_step) | max(min_ct | int) }}

      # Sinon, si pas de color_temp, log et ne rien faire
      - conditions: >
          {{
            state_attr(light, 'color_temp') is none
          }}
        sequence:
          - service: system_log.write
            data:
              level: info
              message: >
                La lumière {{ light }} ne supporte pas la variation de température couleur, action ignorée.

